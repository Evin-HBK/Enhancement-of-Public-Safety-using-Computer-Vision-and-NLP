<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tweets</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Tweets</h1>
        </div>
        <div class="header-right">
            <h1>Incidents</h1>
        </div>
    </header>
    <div class="content-container">
        <section id="tweets-section">
            <ul id="tweets-list"></ul>
        </section>
        <section id="incident-section">
            <h2 id="incident-type" style="text-align: center;">Latest Incident: {{ incident_data.incident_type }}</h2>
            <img id="incident-frame" src="data:image/jpeg;base64,{{ incident_data.incident_frame }}" alt="Incident Frame" width="640" height="360">
        </section>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var defaultIncidentData = {
            incident_type: "None",
            incident_frame: "{{ incident_data.incident_frame }}",
            tweet: ""
        };
        var incidentData = defaultIncidentData;
        var lastUpdateTime = 0;

        tweet_list=[]
        function updateIncident() {
            fetch('/incident_data')
                .then(response => response.json())
                .then(data => {
                    if (data.timestamp > lastUpdateTime) {
                        // New incident data found
                        incidentData.incident_frame = data.incident_frame;
                        incidentData.incident_type = data.incident_type;
                        lastUpdateTime = data.timestamp;
                        if (!(tweet_list.includes(data.tweet)))
                        {
                            incidentData.tweet=data.tweet;
                            tweet_list.push(data.tweet)
                        }
                    } else if (Date.now() / 1000 - lastUpdateTime > 10) {
                        // No new incident data for 30 seconds
                        incidentData = defaultIncidentData;
                    }
                    document.getElementById('incident-type').textContent = "Latest Incident: " + incidentData.incident_type;
                    document.getElementById('incident-frame').src = "data:image/jpeg;base64," + incidentData.incident_frame;
                    if (incidentData.tweet) {
                        var li = createListItem(incidentData.tweet);
                        document.getElementById('tweets-list').appendChild(li);
                        incidentData.tweet='';
                    }
                });
        }

        function createListItem(text) {
            var li = document.createElement('li');
            var textNode = document.createTextNode(text);
            li.appendChild(textNode);
            return li;
        }

        updateIncident(); // update immediately
        setInterval(updateIncident, 20); // update every 2 seconds
    </script>
</body>
</html>
